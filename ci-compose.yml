services:
  tests_base: &testing
    image: icalialabs/icalia-sdk-ruby${TESTING_IMAGE_TAG:-:testing-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      args:
        DEVELOPER_UID: ${UID:-1000}
        DEVELOPER_USERNAME: ${USER:-you}
    volumes:
      - type: bind
        source: .
        target: /workspaces/icalia-sdk
    
    stdin_open: true
    tty: true

    # [Optional] Required for ptrace-based debuggers like C++, Go, and Rust
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined

    entrypoint: /workspaces/icalia-sdk/bin/dev-entrypoint.sh

    command: bundle exec rake spec

    environment:
      # Use the local pubsub emulator instead of Google Cloud:
      PUBSUB_EMULATOR_HOST: pubsub:8085

  core_tests:
    <<: *testing
    working_dir: /workspaces/icalia-sdk/core

  event_notification_tests:
    <<: *testing
    depends_on:
      - pubsub
    working_dir: /workspaces/icalia-sdk/event-notification
  
  event_webhook_tests:
    <<: *testing
    working_dir: /workspaces/icalia-sdk/event-webhook
  
  event_meta_tests:
    <<: *testing
    depends_on:
      - pubsub
    working_dir: /workspaces/icalia-sdk/event
  
  sdk_meta_tests:
    <<: *testing
    depends_on:
      - pubsub
    working_dir: /workspaces/icalia-sdk/sdk
